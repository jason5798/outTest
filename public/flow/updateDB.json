[{"id":"6377adb1.e11024","type":"function","z":"a6c4d10b.73a6d","name":"Save message to  DB","func":"var debug = false;\nvar deviceDbTools = context.global. deviceDbTools;\nvar moment = context.global.momentModule;\nnode.warn('Updata DB format');\n\n\ndeviceDbTools.findAllDevices(function(err,devices){\n    if(err){\n        console.log(err);\n    }\n    for(var i = 0; i < devices.length; i++){\n        if(debug && i>0){\n            break;\n        }\n        if(debug){\n            node.warn('devices ('+i+'): '+devices[i]);\n        }\n        \n        updateDevice(devices[i]);\n    }\n});\n\n\nfunction updateDevice(device){\n    var mInfo =device.info;\n    if(debug){\n        node.warn('@@@@ device info:'+JSON.stringify(mInfo));\n    }\n    \n    var mData = device.data;\n    \n    mInfo.cond = getIntData([16,20,1000],mData);\n    if(debug){\n        node.warn('after info : '+JSON.stringify(mInfo));\n    }\n    \n    var json = {info:mInfo};\n    deviceDbTools.updateDeviceData(device._id,json);\n}\n\nfunction getIntData(arrRange,data){\n    var ret = {};\n    var start = arrRange[0];\n    var end = arrRange[1];\n    var diff = arrRange[2];\n    var intData = parseInt(data.substring(start,end),16);\n   \n    if(diff === 1)\n        return intData;\n    else\n        return intData/diff;\n}\n\nfunction saveDevice(device){\n    console.log('mac : '+ device.macAddr);\n    console.log('data : '+ device.data);\n    console.log('recv_at : '+ device.recv_at);\n    deviceDbTools.saveDevice(device.macAddr,device.data,device.recv_at,function(err,info){\n        console.log('Debug save Device -----------------------------');\n        if(err){\n            console.log('Debug save Device fail : '+err);\n            return;\n        }\n        console.log('Debug save Device success ');\n        console.log('Debug info.voltage : '+info.data4);\n    });\n    delDeviceById(device._id);\n}\n\nfunction delDeviceById(device){\n    var _id = device._id;\n    console.log('_id : '+ _id);\n    deviceDbTools.removeDeviceById(_id,function(err,result){\n        console.log('Debug remove Device By Id -----------------------------');\n        if(err){\n            console.log('Debug remove Device By Id fail : '+err);\n        }\n        console.log('Debug remove Device By Id success ');\n    });\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":379.8125,"y":166.81875610351562,"wires":[[]]},{"id":"8ba538e1.07da38","type":"inject","z":"a6c4d10b.73a6d","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":147.50624084472656,"y":159.37498474121094,"wires":[["6377adb1.e11024"]]}]